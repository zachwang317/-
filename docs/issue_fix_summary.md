# 问题修复说明

## ✅ 已修复的问题

### 问题1：输出表单结构问题

**问题描述**：输出的CSV文件中，所有列混在一起，没有按照原始列在前、翻译列在后的顺序排列。

**修复方案**：
修改了 `src/graphs/nodes/merge_translations_node.py`，确保列名顺序正确：
1. 先添加所有原始列
2. 然后按目标语言顺序添加翻译列
3. 对于每个目标语言，添加所有中文列对应的翻译列

**修复结果**：
修复后的列名顺序：
```
商品名称, 商品描述, 价格, 商品名称_英文_翻译, 商品描述_英文_翻译, 商品名称_日文_翻译, 商品描述_日文_翻译
```

**示例输出**：
| 商品名称 | 商品描述 | 价格 | 商品名称_英文_翻译 | 商品描述_英文_翻译 | 商品名称_日文_翻译 | 商品描述_日文_翻译 |
|---------|---------|------|------------------|------------------|------------------|------------------|
| 天使扣 | 这是天使扣的描述，非常适合使用 | 100 | Sun Umbrella | This is the description of the sun umbrella, which is very suitable for use | 日傘 | これは日傘の説明です。非常に使いやすいです |
| 蝴蝶结 | 精美的蝴蝶结，装饰性强 | 50 | Bowknot | Exquisite bowknot with strong decorative effect | リボン | 美しいリボンで、装飾性に優れています |
| 玫瑰花 | 可爱的玫瑰花，深受欢迎 | 80 | Rose | Lovely rose, very popular | バラ | 愛らしいバラで、人気があります |

---

### 问题2：术语知识库查询问题

**问题描述**：数据库中维护了"天使扣"对应的英文翻译，但翻译时没有参考到。

**修复方案**：
1. 优化了 `src/graphs/nodes/query_terminology_node.py` 的解析逻辑
2. 增加了多种解析方式，提高兼容性：
   - 表格格式：`中文|英语|日语`
   - CSV格式：`中文,英语,日语`
   - JSON格式
   - 箭头格式：`中文 -> 翻译`
3. 添加了调试日志，方便排查问题
4. 为每个目标语言分别查询，避免混淆

**代码改进**：
```python
# 为每个目标语言分别查询
for target_lang, kb_column in target_columns:
    for i in range(0, len(word_list), batch_size):
        batch_words = word_list[i:i + batch_size]
        query = "\n".join(batch_words)
        
        response = kb_client.search(
            query=query,
            table_names=["多语言翻译工具知识库"],
            top_k=10,
            min_score=0.3
        )
        
        # 尝试多种方式提取翻译
        # 方式1：表格格式
        # 方式2：CSV格式
        # 方式3：JSON格式
        # 方式4：箭头格式
```

**重要提示**：
当前测试发现，知识库查询失败，返回错误：
```
"msg": "[Coze Knowledge] internal error: no database found for project 7600392"
```

这说明**当前项目没有配置知识库数据库**。代码逻辑已经优化，但需要先在项目中配置知识库。

---

## 📋 知识库配置指南

### 步骤1：创建知识库

在Coze平台上创建一个知识库，命名为"多语言翻译工具知识库"。

### 步骤2：导入术语数据

知识库的数据格式可以是以下任何一种：

**格式1：表格格式（推荐）**
```
中文|英语|日语|韩语|法语|德语
天使扣|Angel Buckle|エンジェルバックル|엔젤버클|Boucle d'ange|Engelsschnalle
蝴蝶结|Bowknot|リボン|나비넥타이|Nœud papillon|Schleife
```

**格式2：CSV格式**
```
中文,英语,日语,韩语
天使扣,Angel Buckle,エンジェルバックル,엔젤버클
蝴蝶结,Bowknot,リボン,나비넥타イ
```

**格式3：JSON格式**
```json
{
  "天使扣": {
    "英语": "Angel Buckle",
    "日语": "エンジェルバックル"
  },
  "蝴蝶结": {
    "英语": "Bowknot",
    "日语": "リボン"
  }
}
```

**格式4：箭头格式**
```
天使扣 -> Angel Buckle (英语) -> エンジェルバックル (日语)
蝴蝶结 -> Bowknot (英语) -> リボン (日语)
```

### 步骤3：在代码中使用

知识库配置完成后，工作流会自动查询和使用术语。不需要修改代码。

### 步骤4：验证

运行工作流后，检查日志输出：
```
知识库查询完成，共找到 X 个术语的翻译
  天使扣: {'英文': 'Angel Buckle', '日文': 'エンジェルバックル'}
  蝴蝶结: {'英文': 'Bowknot', '日文': 'リボン'}
```

如果看到上述日志，说明知识库查询成功。

---

## 🔍 故障排查

### 问题：知识库查询失败，返回空字典

**可能原因**：
1. 知识库没有配置
2. 知识库名称不匹配（必须是"多语言翻译工具知识库"）
3. 知识库中没有相关术语
4. 知识库数据格式不被识别

**解决方法**：
1. 确认知识库已正确配置
2. 确认知识库名称正确
3. 检查知识库中是否有对应的术语
4. 尝试使用表格格式（最稳定）

### 问题：术语没有出现在翻译结果中

**可能原因**：
1. 知识库查询失败
2. 术语不在知识库中
3. 知识库中该术语的翻译为空
4. 大模型没有使用提供的术语

**解决方法**：
1. 检查日志，确认知识库查询是否成功
2. 在知识库中添加术语
3. 确保知识库中该术语有有效的翻译
4. 在系统提示词中强调使用术语

---

## 📊 测试结果

### 测试用例
输入CSV：
```
商品名称,商品描述,价格
天使扣,这是天使扣的描述，非常适合使用,100
蝴蝶结,精美的蝴蝶结，装饰性强,50
玫瑰花,可爱的玫瑰花，深受欢迎,80
```

目标语言：英文、日文

### 测试结果
✅ **输出表单结构正确**
- 列名顺序：商品名称, 商品描述, 价格, 商品名称_英文_翻译, 商品描述_英文_翻译, 商品名称_日文_翻译, 商品描述_日文_翻译
- 所有列正确显示

⚠️ **知识库查询失败**
- 原因：项目未配置知识库数据库
- 影响：术语未被参考，翻译结果使用大模型直接翻译
- 解决：配置知识库后，术语将被自动引用

---

## 🎯 总结

### 已完成
1. ✅ 修复输出表单结构问题
2. ✅ 优化术语知识库查询代码
3. ✅ 增加多种解析方式
4. ✅ 添加调试日志

### 待完成
1. ⚠️ 配置知识库数据库
2. ⚠️ 导入术语数据到知识库
3. ⚠️ 验证知识库查询功能

### 建议
1. 优先配置知识库，启用术语翻译功能
2. 使用表格格式的数据导入（最稳定）
3. 定期维护知识库中的术语数据
4. 监控日志输出，确保知识库查询成功

---

## 📝 相关文件

- `src/graphs/nodes/merge_translations_node.py` - 合并翻译结果节点
- `src/graphs/nodes/query_terminology_node.py` - 术语查询节点
- `config/translate_llm_cfg.json` - 大模型配置
- `docs/workflow_details.md` - 工作流详细文档
